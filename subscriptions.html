<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الاشتراكات</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>إدارة الاشتراكات</h1>
    <button id="renewExpired">تجديد الاشتراكات المنتهية</button>
    <table id="subscriptionsTable">
        <thead>
            <tr>
                <th>اسم المشترك</th>
                <th>نوع الاشتراك</th>
                <th>تاريخ البداية</th>
                <th>تاريخ النهاية</th>
                <th>إجراءات</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>أحمد علي</td>
                <td>شهري</td>
                <td>2024-10-01</td>
                <td>2024-11-01</td>
                <td>
                    <button onclick="editSubscription(this)">تعديل</button>
                    <button onclick="deleteSubscription(this)">حذف</button>
                </td>
            </tr>
            <tr>
                <td>سارة محمد</td>
                <td>سنوي</td>
                <td>2023-10-01</td>
                <td>2024-09-30</td>
                <td>
                    <button onclick="editSubscription(this)">تعديل</button>
                    <button onclick="deleteSubscription(this)">حذف</button>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            // زر تجديد الاشتراكات المنتهية
            $("#renewExpired").click(function () {
                const expiredRows = [];
                $("#subscriptionsTable tbody tr").each(function () {
                    const endDate = new Date($(this).find("td").eq(3).text());
                    const today = new Date();

                    if (endDate < today) {
                        const memberName = $(this).find("td").eq(0).text();
                        expiredRows.push(memberName);
                    }
                });

                if (expiredRows.length > 0) {
                    Swal.fire({
                        title: "تجديد الاشتراكات المنتهية",
                        text: `تم العثور على اشتراكات منتهية: ${expiredRows.join(", ")}`,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "تجديد الآن",
                        cancelButtonText: "إلغاء",
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $("#subscriptionsTable tbody tr").each(function () {
                                const endDate = new Date($(this).find("td").eq(3).text());
                                const today = new Date();

                                if (endDate < today) {
                                    const newEndDate = new Date();
                                    newEndDate.setMonth(newEndDate.getMonth() + 1);
                                    const formattedEndDate = newEndDate.toISOString().split("T")[0];
                                    $(this).find("td").eq(3).text(formattedEndDate);
                                }
                            });
                            Swal.fire("تم!", "تم تجديد جميع الاشتراكات المنتهية بنجاح", "success");
                        }
                    });
                } else {
                    Swal.fire("لا توجد اشتراكات منتهية", "كل الاشتراكات سارية", "info");
                }
            });
        });

        // زر تعديل الاشتراك
        function editSubscription(button) {
            const row = $(button).closest("tr");
            const memberName = row.find("td").eq(0).text();
            const subscriptionType = row.find("td").eq(1).text();
            const startDate = row.find("td").eq(2).text();
            const endDate = row.find("td").eq(3).text();

            Swal.fire({
                title: "تعديل الاشتراك",
                html: `
                    <label>اسم المشترك</label>
                    <input id="editName" class="swal2-input" value="${memberName}">
                    <label>نوع الاشتراك</label>
                    <input id="editType" class="swal2-input" value="${subscriptionType}">
                    <label>تاريخ البداية</label>
                    <input id="editStart" class="swal2-input" value="${startDate}" type="date">
                    <label>تاريخ النهاية</label>
                    <input id="editEnd" class="swal2-input" value="${endDate}" type="date">
                `,
                showCancelButton: true,
                confirmButtonText: "حفظ",
                cancelButtonText: "إلغاء",
                preConfirm: () => {
                    return {
                        name: $("#editName").val(),
                        type: $("#editType").val(),
                        start: $("#editStart").val(),
                        end: $("#editEnd").val(),
                    };
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    row.find("td").eq(0).text(result.value.name);
                    row.find("td").eq(1).text(result.value.type);
                    row.find("td").eq(2).text(result.value.start);
                    row.find("td").eq(3).text(result.value.end);
                    Swal.fire("تم!", "تم تعديل الاشتراك بنجاح", "success");
                }
            });
        }

        // زر حذف الاشتراك
        function deleteSubscription(button) {
            const row = $(button).closest("tr");
            const memberName = row.find("td").eq(0).text();

            Swal.fire({
                title: "تأكيد الحذف",
                text: `هل تريد حذف اشتراك ${memberName}؟`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "نعم، حذف",
                cancelButtonText: "إلغاء",
            }).then((result) => {
                if (result.isConfirmed) {
                    row.remove();
                    Swal.fire("تم!", "تم حذف الاشتراك بنجاح", "success");
                }
            });
        }
    </script>
</body>
</html>
