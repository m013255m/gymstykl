<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الاشتراكات</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body dir="rtl" class="container mt-5">

    <h2>إدارة الاشتراكات</h2>
    <button id="showExpiredSubscriptions" class="btn btn-warning mb-3">عرض الاشتراكات المنتهية</button>

    <table id="subscriptionsTable" class="table table-striped">
        <thead>
            <tr>
                <th>اسم العضو</th>
                <th>نوع الاشتراك</th>
                <th>تاريخ البداية</th>
                <th>تاريخ النهاية</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody>
            <!-- البيانات ستتم إضافتها ديناميكيًا -->
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            // بيانات تجريبية
            const demoData = [
                { memberName: "محمد أحمد", subscriptionType: "شهري", startDate: "2024-11-01", endDate: "2024-12-01" },
                { memberName: "سارة علي", subscriptionType: "سنوي", startDate: "2023-12-01", endDate: "2024-11-30" },
                { memberName: "أحمد علي", subscriptionType: "شهري", startDate: "2024-10-01", endDate: "2024-11-05" }
            ];

            // تحميل البيانات في الجدول
            function loadTableData(data) {
                const tbody = $("#subscriptionsTable tbody");
                tbody.empty();
                data.forEach((item, index) => {
                    const row = `<tr data-index="${index}">
                        <td>${item.memberName}</td>
                        <td>${item.subscriptionType}</td>
                        <td>${item.startDate}</td>
                        <td>${item.endDate}</td>
                        <td>
                            <button class="btn btn-primary btn-sm editSubscription">تعديل</button>
                        </td>
                    </tr>`;
                    tbody.append(row);
                });
            }

            // استدعاء لتحميل البيانات
            loadTableData(demoData);

            // عرض الاشتراكات المنتهية
            $("#showExpiredSubscriptions").click(function () {
                const today = new Date().toISOString().split("T")[0];
                const expiredSubscriptions = demoData.filter(sub => sub.endDate < today);

                if (expiredSubscriptions.length > 0) {
                    let expiredTable = `
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>اسم العضو</th>
                                    <th>نوع الاشتراك</th>
                                    <th>تاريخ البداية</th>
                                    <th>تاريخ النهاية</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    expiredSubscriptions.forEach((sub, index) => {
                        expiredTable += `
                            <tr data-index="${index}">
                                <td contenteditable="true">${sub.memberName}</td>
                                <td contenteditable="true">${sub.subscriptionType}</td>
                                <td contenteditable="true">${sub.startDate}</td>
                                <td contenteditable="true">${sub.endDate}</td>
                            </tr>`;
                    });

                    expiredTable += `</tbody></table>`;

                    Swal.fire({
                        title: "الاشتراكات المنتهية",
                        html: expiredTable,
                        confirmButtonText: "حفظ التعديلات",
                        showCancelButton: true,
                        cancelButtonText: "إغلاق",
                        preConfirm: () => {
                            const updatedData = [];
                            Swal.getHtmlContainer().querySelectorAll("tbody tr").forEach(row => {
                                const cells = row.querySelectorAll("td");
                                const updatedRow = {
                                    memberName: cells[0].innerText,
                                    subscriptionType: cells[1].innerText,
                                    startDate: cells[2].innerText,
                                    endDate: cells[3].innerText
                                };
                                updatedData.push(updatedRow);
                            });

                            // تحديث البيانات الأصلية
                            updatedData.forEach((sub, index) => {
                                const originalIndex = expiredSubscriptions[index].originalIndex;
                                demoData[originalIndex] = sub;
                            });

                            // إعادة تحميل الجدول الرئيسي
                            loadTableData(demoData);
                            Swal.fire("تم حفظ التعديلات!", "", "success");
                        }
                    });
                } else {
                    Swal.fire("لا توجد اشتراكات منتهية", "", "info");
                }
            });

            // تعديل الاشتراك في الجدول الرئيسي
            $(document).on("click", ".editSubscription", function () {
                const row = $(this).closest("tr");
                const index = row.data("index");
                const subscription = demoData[index];

                Swal.fire({
                    title: "تعديل الاشتراك",
                    html: `
                        <input type="text" id="editMemberName" class="swal2-input" value="${subscription.memberName}" placeholder="اسم العضو">
                        <input type="text" id="editSubscriptionType" class="swal2-input" value="${subscription.subscriptionType}" placeholder="نوع الاشتراك">
                        <input type="date" id="editStartDate" class="swal2-input" value="${subscription.startDate}" placeholder="تاريخ البداية">
                        <input type="date" id="editEndDate" class="swal2-input" value="${subscription.endDate}" placeholder="تاريخ النهاية">`,
                    confirmButtonText: "حفظ التعديلات",
                    showCancelButton: true,
                    cancelButtonText: "إلغاء",
                    preConfirm: () => {
                        const newMemberName = $("#editMemberName").val();
                        const newSubscriptionType = $("#editSubscriptionType").val();
                        const newStartDate = $("#editStartDate").val();
                        const newEndDate = $("#editEndDate").val();

                        if (newMemberName && newSubscriptionType && newStartDate && newEndDate) {
                            // تحديث البيانات
                            demoData[index] = {
                                memberName: newMemberName,
                                subscriptionType: newSubscriptionType,
                                startDate: newStartDate,
                                endDate: newEndDate
                            };
                            loadTableData(demoData);
                            Swal.fire("تم!", "تم تحديث الاشتراك بنجاح.", "success");
                        } else {
                            Swal.showValidationMessage("الرجاء ملء جميع الحقول");
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
